// Rewrite this code and understand it better. The old solution is a mess.